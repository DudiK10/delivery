<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <title>מערכת ניהול משלוחים</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCAoqZcRqAlFYGkQ6oCoQCctvkCq4SnPCM&libraries=places"></script>
    
    <style>
        body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; display: flex; height: 100vh; overflow: hidden; background: #f4f6f8; }
        
        #sidebar { 
            width: 400px; background: white; padding: 25px; 
            box-shadow: 4px 0 15px rgba(0,0,0,0.05); z-index: 10; 
            overflow-y: auto; display: flex; flex-direction: column; gap: 20px; 
        }

        #map { flex-grow: 1; height: 100%; }

        h2 { margin: 0; color: #2c3e50; font-size: 22px; display: flex; align-items: center; gap: 10px; }
        .section-title { 
            font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;
            color: #7f8c8d; font-weight: 700; border-bottom: 2px solid #ecf0f1; 
            padding-bottom: 8px; margin-bottom: 10px; 
        }

        .input-group { position: relative; margin-bottom: 12px; transition: all 0.3s; }
        .input-wrapper { position: relative; }
        
        input { 
            width: 100%; padding: 14px; /* ביטלנו את הריווח הגדול לאייקון */
            border: 1px solid #dfe6e9; border-radius: 8px; 
            font-size: 14px; box-sizing: border-box; transition: 0.2s; background: #fdfdfd;
        }
        input:focus { border-color: #3498db; outline: none; background: white; box-shadow: 0 0 0 3px rgba(52,152,219,0.1); }
        
        /* צבעים שונים לסוגי שדות (פס צדדי בלבד) */
        .pickup-field input { border-right: 5px solid #2ecc71; } /* ירוק */
        .drop-field input { border-right: 5px solid #e74c3c; } /* אדום */

        /* כפתור מחיקה */
        .remove-btn { 
            position: absolute; left: 10px; top: 50%; transform: translateY(-50%); 
            cursor: pointer; color: #dfe6e9; border: none; background: none; font-size: 16px; 
            transition: 0.2s;
        }
        .remove-btn:hover { color: #e74c3c; }

        button { 
            padding: 14px; border: none; border-radius: 8px; font-size: 15px; 
            cursor: pointer; font-weight: 600; transition: 0.2s; 
            display: flex; align-items: center; justify-content: center; gap: 10px; 
        }
        
        #addBtn { background: #f1f2f6; color: #2c3e50; border: 1px dashed #bdc3c7; }
        #addBtn:hover { background: #dfe4ea; border-color: #a4b0be; }
        
        #sendBtn { 
            background: #3498db; color: white; margin-top: auto; 
            box-shadow: 0 4px 10px rgba(52,152,219,0.3); 
        }
        #sendBtn:hover { background: #2980b9; transform: translateY(-2px); }

        .status-card { 
            background: white; padding: 15px; border-radius: 10px; 
            border: 1px solid #ecf0f1; display: flex; align-items: center; gap: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .status-icon-bg {
            width: 40px; height: 40px; background: #ecf0f1; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: #95a5a6;
        }
        .status-active .status-icon-bg { background: #e8f8f5; color: #2ecc71; }
        .status-text { font-size: 14px; font-weight: bold; color: #7f8c8d; }
        .status-sub { font-size: 11px; color: #bdc3c7; margin-top: 2px; }

    </style>
</head>
<body>

    <div id="sidebar">
        <h2><i class="fa-solid fa-truck-fast"></i> מרכז שליטה</h2>
        
        <div>
            <div class="section-title">נקודת איסוף (מחסן)</div>
            <div id="pickup-container"></div>
        </div>

        <div style="flex-grow: 1; display: flex; flex-direction: column; gap: 10px;">
            <div class="section-title">נקודות פיזור (לקוחות)</div>
            <div id="drops-container"></div>
            
            <button id="addBtn" onclick="addDrop()">
                <i class="fa-solid fa-plus"></i> הוסף לקוח נוסף
            </button>
        </div>
        
        <div class="status-card" id="statusCard">
            <div class="status-icon-bg">
                <i class="fa-solid fa-motorcycle"></i>
            </div>
            <div>
                <div class="status-text" id="courierStatus">השליח מנותק</div>
                <div class="status-sub" id="lastUpdate">ממתין לחיבור...</div>
            </div>
        </div>

        <button id="sendBtn" onclick="dispatchMission()">
            <i class="fa-solid fa-paper-plane"></i> שגר מסלול לשליח
        </button>
    </div>

    <div id="map"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAFHYCL-RffNlfw177y6_02w_9uVu7VN2M",
            authDomain: "deliveryapp-cc4e7.firebaseapp.com",
            projectId: "deliveryapp-cc4e7",
            storageBucket: "deliveryapp-cc4e7.firebasestorage.app",
            messagingSenderId: "51735016579",
            appId: "1:51735016579:web:cd122223777a4a4672d7b6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let map, courierMarker;

        window.initMap = function() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 32.0853, lng: 34.7818 },
                zoom: 12,
                disableDefaultUI: false,
                styles: [{ "featureType": "poi", "stylers": [{ "visibility": "off" }] }]
            });

            // יצירת שדות ללא אייקונים
            createInput("pickup-container", "הזן כתובת איסוף...", "pickup-field", false);
            addDrop();

            listenToCourier();
        }

        function listenToCourier() {
            onSnapshot(doc(db, "couriers", "courier1"), (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    const pos = { lat: data.latitude, lng: data.longitude };
                    
                    const statusCard = document.getElementById("statusCard");
                    statusCard.classList.add("status-active");
                    document.getElementById("courierStatus").innerText = "השליח מחובר ובתנועה";
                    document.getElementById("courierStatus").style.color = "#2ecc71";
                    document.getElementById("lastUpdate").innerText = "עודכן: " + new Date().toLocaleTimeString();

                    if (!courierMarker) {
                        courierMarker = new google.maps.Marker({
                            position: pos, map: map,
                            icon: { 
                                url: "https://cdn-icons-png.flaticon.com/512/3063/3063823.png", 
                                scaledSize: new google.maps.Size(45, 45) 
                            },
                            title: "השליח",
                            animation: google.maps.Animation.DROP
                        });
                    } else {
                        courierMarker.setPosition(pos);
                    }
                    map.panTo(pos);
                }
            });
        }

        // פונקציה מעודכנת ללא פרמטר לאייקון
        function createInput(containerId, placeholder, cssClass, isRemovable) {
            const container = document.getElementById(containerId);
            const wrapper = document.createElement("div");
            wrapper.className = `input-group ${cssClass}`;
            
            // הסרנו את ה-<i> של האייקון מכאן
            wrapper.innerHTML = `
                <div class="input-wrapper">
                    <input type="text" placeholder="${placeholder}">
                </div>
            `;

            const input = wrapper.querySelector("input");
            
            const autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.setFields(["geometry", "formatted_address"]);
            
            input.selectedLocation = null;
            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                if (!place.geometry) {
                    alert("נא לבחור כתובת תקינה מהרשימה!");
                    return;
                }
                input.selectedLocation = {
                    lat: place.geometry.location.lat(),
                    lng: place.geometry.location.lng(),
                    address: place.formatted_address
                };
                
                input.style.borderColor = "#2ecc71";
                input.style.background = "#f0fff4";
            });

            if (isRemovable) {
                const btn = document.createElement("button");
                btn.className = "remove-btn";
                btn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                btn.title = "הסר שורה";
                btn.onclick = () => container.removeChild(wrapper);
                wrapper.querySelector(".input-wrapper").appendChild(btn);
            }

            container.appendChild(wrapper);
        }

        window.addDrop = function() {
            createInput("drops-container", "כתובת למסירה...", "drop-field", true);
        }

        window.dispatchMission = async function() {
            const pickupInput = document.querySelector("#pickup-container input");
            if (!pickupInput.selectedLocation) {
                alert("⚠️ חובה להגדיר נקודת איסוף!");
                return;
            }

            const dropInputs = document.querySelectorAll("#drops-container input");
            const drops = [];
            for (let input of dropInputs) {
                if (input.selectedLocation) {
                    drops.push(input.selectedLocation);
                }
            }

            if (drops.length === 0) {
                alert("⚠️ חובה להוסיף לפחות לקוח אחד לפיזור.");
                return;
            }

            const finalRoute = [pickupInput.selectedLocation, ...drops];

            const btn = document.getElementById("sendBtn");
            const originalHTML = btn.innerHTML;
            
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> מעבד ושולח...';
            btn.style.opacity = "0.7";
            
            try {
                await setDoc(doc(db, "deliveries", "mission1"), {
                    stops: finalRoute,
                    timestamp: new Date(),
                    status: "dispatched"
                });
                
                btn.innerHTML = '<i class="fa-solid fa-check"></i> נשלח בהצלחה!';
                btn.style.background = "#2ecc71";
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.background = "#3498db";
                    btn.style.opacity = "1";
                }, 3000);

            } catch (e) {
                console.error(e);
                alert("שגיאה: " + e.message);
                btn.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> שגיאה';
                btn.style.background = "#e74c3c";
            }
        }

        window.initMap();
    </script>
</body>
</html>