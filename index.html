<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <title>מערכת ניהול - תצוגה מלאה</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCAoqZcRqAlFYGkQ6oCoQCctvkCq4SnPCM&libraries=places,geometry"></script>
    
    <style>
        body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; display: flex; height: 100vh; overflow: hidden; background: #f4f6f8; }
        
        #sidebar { 
            width: 380px; background: white; padding: 20px; 
            box-shadow: 4px 0 15px rgba(0,0,0,0.05); z-index: 10; 
            overflow-y: auto; display: flex; flex-direction: column; gap: 15px; 
        }

        #map { flex-grow: 1; height: 100%; }

        h2 { margin: 0; color: #2c3e50; font-size: 20px; display: flex; align-items: center; gap: 10px; }
        .section-title { font-size: 12px; color: #7f8c8d; font-weight: bold; border-bottom: 2px solid #ecf0f1; padding-bottom: 5px; margin-bottom: 10px; }

        .input-group { 
            position: relative; 
            margin-bottom: 10px; 
            width: 100%;
        }
        
        input { 
            width: 100%; 
            padding: 12px;
            padding-left: 40px; /* מקום ל-X */
            border: 1px solid #dfe6e9; border-radius: 6px; 
            font-size: 14px; box-sizing: border-box; background: #fdfdfd;
        }
        input:focus { border-color: #3498db; outline: none; background: white; }
        
        .pickup-field input { border-right: 4px solid #2ecc71; }
        .drop-field input { border-right: 4px solid #e74c3c; }

        /* כפתור המחיקה - מתוקן */
        .remove-btn { 
            position: absolute; 
            left: 5px; 
            top: 50%; 
            transform: translateY(-50%); 
            width: 30px !important; 
            height: 30px;
            cursor: pointer; 
            color: #bdc3c7; 
            border: none; background: none; 
            font-size: 16px; 
            padding: 0;
            z-index: 10;
            display: flex; align-items: center; justify-content: center;
        }
        .remove-btn:hover { color: #e74c3c; background-color: rgba(231, 76, 60, 0.1); border-radius: 50%; }

        button { 
            padding: 12px; border: none; border-radius: 6px; font-size: 14px; 
            cursor: pointer; font-weight: 600; transition: 0.2s; width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 8px; 
        }
        
        #addBtn { background: #f1f2f6; color: #2c3e50; border: 1px dashed #bdc3c7; }
        #addBtn:hover { background: #dfe4ea; }
        
        #sendBtn { background: #3498db; color: white; margin-top: auto; }
        #sendBtn:hover { background: #2980b9; }

        .status-card { 
            background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #ecf0f1; 
            display: flex; align-items: center; gap: 15px; 
        }
        .status-icon-bg {
            width: 35px; height: 35px; background: #ecf0f1; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: #95a5a6;
        }
        .status-active .status-icon-bg { background: #e8f8f5; color: #2ecc71; }
        .status-text { font-size: 13px; font-weight: bold; color: #7f8c8d; }
        .status-sub { font-size: 11px; color: #bdc3c7; }

    </style>
</head>
<body>

    <div id="sidebar">
        <h2><i class="fa-solid fa-map-location-dot"></i> ניהול משלוחים</h2>
        
        <div class="status-card" id="statusCard">
            <div class="status-icon-bg"><i class="fa-solid fa-car-side"></i></div>
            <div>
                <div class="status-text" id="courierStatus">ממתין לחיבור שליח...</div>
                <div class="status-sub" id="lastUpdate">--:--</div>
            </div>
        </div>

        <div style="margin-top: 15px;">
            <div class="section-title">הגדרת מסלול חדש</div>
            <div id="pickup-container"></div>
            <div id="drops-container"></div>
            <button id="addBtn" onclick="addDrop()"><i class="fa-solid fa-plus"></i> הוסף יעד</button>
        </div>

        <button id="sendBtn" onclick="dispatchMission()">
            <i class="fa-solid fa-paper-plane"></i> שגר משימה לשליח
        </button>
    </div>

    <div id="map"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAFHYCL-RffNlfw177y6_02w_9uVu7VN2M",
            authDomain: "deliveryapp-cc4e7.firebaseapp.com",
            projectId: "deliveryapp-cc4e7",
            storageBucket: "deliveryapp-cc4e7.firebasestorage.app",
            messagingSenderId: "51735016579",
            appId: "1:51735016579:web:cd122223777a4a4672d7b6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let map, courierMarker;
        let directionsService, directionsRenderer;
        let routeMarkers = []; 

        window.initMap = function() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 32.0853, lng: 34.7818 },
                zoom: 12,
                disableDefaultUI: false
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: true, 
                polylineOptions: {
                    strokeColor: "#4285F4", 
                    strokeWeight: 5
                }
            });

            createInput("pickup-container", "נקודת איסוף...", "pickup-field", false);
            addDrop();

            listenToCourier();
            listenToMission();
        }

        function listenToCourier() {
            onSnapshot(doc(db, "couriers", "courier1"), (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    const pos = { lat: data.latitude, lng: data.longitude };
                    
                    updateStatusCard(true);

                    if (!courierMarker) {
                        courierMarker = new google.maps.Marker({
                            position: pos, map: map,
                            icon: { 
                                url: "https://cdn-icons-png.flaticon.com/512/7541/7541900.png", 
                                scaledSize: new google.maps.Size(50, 50),
                                anchor: new google.maps.Point(25, 25)
                            },
                            title: "השליח",
                            zIndex: 999
                        });
                    } else {
                        courierMarker.setPosition(pos);
                    }
                }
            });
        }

        function listenToMission() {
            onSnapshot(doc(db, "deliveries", "mission1"), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.stops && Array.isArray(data.stops) && data.stops.length >= 2) {
                        calculateAndDrawRoute(data.stops);
                    } else {
                        directionsRenderer.setDirections({routes: []});
                        clearRouteMarkers();
                    }
                }
            });
        }

        function calculateAndDrawRoute(stops) {
            const origin = stops[0];
            const destination = stops[stops.length - 1];
            // שולחים את כל נקודות האמצע
            const waypoints = stops.slice(1, -1).map(stop => ({
                location: { lat: stop.lat, lng: stop.lng },
                stopover: true
            }));

            const request = {
                origin: { lat: origin.lat, lng: origin.lng },
                destination: { lat: destination.lat, lng: destination.lng },
                waypoints: waypoints,
                optimizeWaypoints: true, // <--- התיקון החשוב: בקשה מגוגל לסדר את המסלול
                travelMode: 'DRIVING'
            };

            directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    
                    // --- סידור מחדש של המספרים לפי מה שגוגל החליט ---
                    const optimizedOrder = result.routes[0].waypoint_order;
                    
                    // בונים את המערך מחדש לפי הסדר האופטימלי:
                    // 1. התחלה
                    const sortedStops = [stops[0]];
                    
                    // 2. האמצע (לפי הסדר של גוגל)
                    optimizedOrder.forEach(index => {
                        // האינדקס של גוגל מתייחס ל-waypoints (בלי ההתחלה והסוף)
                        // לכן מוסיפים +1 כדי למצוא את הנקודה במערך המקורי
                        sortedStops.push(stops[index + 1]);
                    });
                    
                    // 3. הסוף
                    sortedStops.push(stops[stops.length - 1]);

                    // מציירים את המספרים לפי הסדר החדש והנכון
                    drawNumberedMarkers(sortedStops); 
                } else {
                    console.error("Directions request failed due to " + status);
                }
            });
        }

        function drawNumberedMarkers(stops) {
            clearRouteMarkers(); 

            stops.forEach((stop, index) => {
                const color = index === 0 ? "2ecc71" : "e74c3c"; 
                
                const marker = new google.maps.Marker({
                    position: { lat: stop.lat, lng: stop.lng },
                    map: map,
                    label: {
                        text: (index + 1).toString(),
                        color: "white",
                        fontWeight: "bold"
                    },
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 16,
                        fillColor: "#" + color,
                        fillOpacity: 1,
                        strokeWeight: 2,
                        strokeColor: "white",
                    },
                    zIndex: 10 + index
                });

                routeMarkers.push(marker);
            });
        }

        function clearRouteMarkers() {
            for (let i = 0; i < routeMarkers.length; i++) {
                routeMarkers[i].setMap(null);
            }
            routeMarkers = [];
        }

        function updateStatusCard(active) {
            const card = document.getElementById("statusCard");
            const text = document.getElementById("courierStatus");
            const time = document.getElementById("lastUpdate");
            
            if (active) {
                card.classList.add("status-active");
                text.innerText = "השליח מחובר";
                text.style.color = "#2ecc71";
                time.innerText = "עדכון אחרון: " + new Date().toLocaleTimeString();
            }
        }

        function createInput(containerId, placeholder, cssClass, isRemovable) {
            const container = document.getElementById(containerId);
            const wrapper = document.createElement("div");
            wrapper.className = `input-group ${cssClass}`;
            wrapper.innerHTML = `<input type="text" placeholder="${placeholder}">`;

            const input = wrapper.querySelector("input");
            const autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.setFields(["geometry", "formatted_address"]);
            
            input.selectedLocation = null;
            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                if (!place.geometry) return;
                input.selectedLocation = {
                    lat: place.geometry.location.lat(),
                    lng: place.geometry.location.lng(),
                    address: place.formatted_address
                };
                input.style.borderColor = "#2ecc71";
                input.style.background = "#f0fff4";
            });

            if (isRemovable) {
                const btn = document.createElement("button");
                btn.className = "remove-btn";
                btn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                btn.title = "הסר שורה";
                btn.onclick = () => container.removeChild(wrapper);
                wrapper.appendChild(btn);
            }
            container.appendChild(wrapper);
        }

        window.addDrop = function() {
            createInput("drops-container", "הוסף כתובת פיזור...", "drop-field", true);
        }

        window.dispatchMission = async function() {
            const pickupInput = document.querySelector("#pickup-container input");
            if (!pickupInput.selectedLocation) { alert("חובה להזין כתובת איסוף"); return; }

            const dropInputs = document.querySelectorAll("#drops-container input");
            const drops = [];
            for (let input of dropInputs) {
                if (input.selectedLocation) drops.push(input.selectedLocation);
            }

            if (drops.length === 0) { alert("חובה להוסיף לפחות יעד אחד"); return; }

            const finalRoute = [pickupInput.selectedLocation, ...drops];
            
            const btn = document.getElementById("sendBtn");
            const oldText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> שולח...';

            try {
                await setDoc(doc(db, "deliveries", "mission1"), {
                    stops: finalRoute,
                    timestamp: new Date(),
                    status: "dispatched"
                });
                
                btn.style.background = "#2ecc71";
                btn.innerHTML = "נשלח בהצלחה!";
                setTimeout(() => {
                    btn.style.background = "#3498db";
                    btn.innerHTML = oldText;
                }, 2000);
            } catch (e) {
                console.error(e);
                alert("שגיאה בשליחה");
                btn.innerHTML = oldText;
            }
        }

        window.initMap();
    </script>
</body>
</html>
